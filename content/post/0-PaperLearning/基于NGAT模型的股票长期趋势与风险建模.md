---
layout:      post
title:       "论文学习《基于NGAT模型的股票长期趋势与风险建模》"
subtitle:    "NGAT: A Node-level Graph Attention Network for Long-term Stock Prediction"
description: "图表示学习方法，特别是图神经网络（GNNs），已成为金融领域的主流技术，其核心优势在于能够利用公司间的关联关系来增强对单个公司的理解和表示。通过将公司建模为图中的节点，将它们之间的关系（如供应链、新闻共现等）作为边，GNNs能够有效捕捉所谓的“动量溢出效应”，即一家公司的股价动向会影响到相关联的其他公司……"
date:        2025-09-24
author:      "Xiangdi Wu"
image:       "/img/background/stellar-trajectory.jpg"
tags:
    - Quant
    - Model

categories: [ Quant ]
URL: "/2025/09/24/ngat-a-node-level-graph-attention-network-for-long-term-stock-prediction/"
# draft: true
---

![Image](/img/2025/09/24/基于NGAT模型的股票长期趋势与风险建模/NGAT-img1.webp)
图表示学习方法，特别是图神经网络（GNNs），已成为金融领域的主流技术，其核心优势在于能够利用公司间的关联关系来增强对单个公司的理解和表示。通过将公司建模为图中的节点，将它们之间的关系（如供应链、新闻共现等）作为边，GNNs能够有效捕捉所谓的“动量溢出效应”，即一家公司的股价动向会影响到相关联的其他公司。

然而，当前基于图模型的股票预测研究范式面临三个核心挑战 ：

1.  **下游任务设计的局限性**：现有研究普遍聚焦于“次日趋势预测”这类短周期任务 ，但这无法充分利用图结构所能捕捉到的、通常具有滞后性的动量溢出效应。同时，这些模型大多只关注收益率，而忽略了波动率——一个衡量市场风险的关键指标。
1.  **模型设计的普适性问题**：通用的GNN架构（如GCN和GAT）假设图中节点的特征分布相似，这在由各具独特行为模式的公司构成的企业关系图（Corporate Relationship Graphs, CRGs）中难以成立。而一些为股票预测定制的复杂模型，则往往以牺牲泛化能力为代价。
1.  **图构建方法的有效性评估缺失**：企业关系图的构建大多依赖于经验，缺乏一套系统性的方法来比较不同图结构的优劣。

为应对这些挑战，本文提出了一套创新的解决方案。首先，设计了一个全新的**长期股票预测任务**，该任务不仅预测未来一段时间的平均收益率趋势，还预测其波动率，从而更好地匹配动量溢出效应的长期特性，并为投资者提供更具操作性的洞见。其次，开发了一种名为**节点级图注意力网络（Node-level Graph Attention Network, NGAT）** 的新型模型架构。NGAT的核心创新在于为每个公司（节点）分配一个独特的注意力机制，使其能根据自身特性学习如何聚合邻居节点的信息，从而完美适应企业关系图的异构性。最后，通过实验揭示了仅依赖下游任务表现来评估图构建方法优劣的局限性。

![Image](/img/2025/09/24/基于NGAT模型的股票长期趋势与风险建模/NGAT-img2.webp)

* * *

#### **问题构建 (Problem Formulation)**

为了克服传统次日预测任务的短视性，本文将研究的核心聚焦于两个全新的长期预测任务：**长期收益率均值预测**与**长期波动率预测**。这两个任务的目标是基于历史数据和企业关系图，预测目标股票在未来为期 T 个交易日内的表现。

**1. 长期收益率趋势预测 (Return Trend Prediction)**

该任务被构建为一个**分类问题**，旨在判断未来 T 日的平均收益率相较于过去 T 日是上涨还是下跌。

-   首先，定义股票 s 在第 d 日的对数收益率：$r^s_d=log(p^s_d/p^s_{d-1})$，其中 $p^s_d$ 是调整后的收盘价。
-   其次，基于此定义分类标签 $y^s_{d,c}$：

    $$y^s_{d,c}=1(\frac{1}{T}\sum\limits_{i=d+1}^{d+T}r^s_i > \frac{1}{T}\sum\limits_{i=d-T+1}^{d}r^s_i)$$
    
    该公式的含义是：如果未来 T 日的平均收益率大于过去 T 日的平均收益率，则标签为1，否则为0。

这个定义巧妙地将股价的未来走势划分成四种具有明确投资含义的情景：

-   **(LP, N+)** : 上一期为正收益（Last period Positive），下一期收益更高（Next period +），定义为  **“飙升 (surge)”** 。
-   **(LN, N+)** : 上一期为负收益（Last period Negative），下一期收益更高，定义为  **“反弹 (rebound)”** 。
-   **(LP, N-)** : 上一期为正收益，下一期收益更低，定义为  **“回调 (pullback)”** 。
-   **(LN, N-)** : 上一期为负收益，下一期收益更低，定义为  **“暴跌 (plunge)”** 。

这四种情景为投资决策提供了清晰的指引。“N+”情景（飙升、反弹）预示着潜在的市场机会，例如，“飙升”情景建议投资者“持有”或“增持”。“N-”情景（回调、暴跌）则警示了下行风险，例如，“暴跌”情景建议“卖出”或“做空”。

**2. 长期波动率预测 (Volatility Prediction)**

该任务被构建为一个**回归问题**，目标是精确预测未来 T 日的波动率数值。

-   本文采用已实现的样本标准差作为波动率的估计值。
-   其计算公式如下：
    
    $y^s_{d,r}=\sqrt{\frac{1}{T}\sum\limits_{i=d+1}^{d+T}(r^s_i-\mu)^2}$，其中 $\mu=\frac{1}{T}\sum\limits_{i=d+1}^{d+T}r^s_i$
    
    这里 $\mu$ 是未来 T 日对数收益率的均值。

通过将收益率趋势预测与波动率预测相结合，投资者不仅能判断未来市场的方向，还能评估该方向预测的可靠性及伴随的风险。这种结合为制定稳健的长期投资策略提供了更全面的市场动态理解。

* * *

#### **模型架构 (Model Architecture)**

本文提出的NGAT模型由三大模块构成：序列嵌入模块、关系嵌入模块和输出层。其整体架构和计算流程如图1所示。

**1. 序列嵌入 (Sequential Embedding)**

为捕捉股价自身的时间序列依赖性，模型首先使用循环神经网络（RNN）对历史交易数据进行编码。遵循业界常规做法，本文选用长短期记忆网络（LSTM）作为序列嵌入模块。

-   对于任意股票 s，在第 d 日，模型输入一个包含过去 $\Delta{d}$ 天交易特征的时间序列矩阵 $X^s_d$。
-   通过LSTM网络生成该股票的序列嵌入向量 $h^s_d$，并取最后一个时间步的输出作为最终的序列表示。

    $$h^s_d=LSTM(X^s_d)$$

**2. 关系嵌入 (Relational Embedding)**

股价的变动不仅受自身历史数据影响，还受到关联股票的联动影响。因此，模型的核心在于如何有效地融合序列嵌入信息与企业间的关系信息，生成关系嵌入。

-   **关系图构建 (Relation Building)**

    -   模型中的企业关系边是基于公司在财经新闻或社交媒体（如推文）中的共现关系动态构建的。
    -   具体而言，对于每日的每一篇新闻，提取其中提及的所有公司，并为这些公司两两之间构建边。
    -   通过对每日新闻进行聚合，得到一个无条件的日度关系属性 $R^{s_i,s_j}_d$。
    -   为了模拟新闻影响的持续性与时效性，模型引入了一个带遗忘机制的时间加权聚合方法，用于计算最终的**条件关系属性** $\hat{R}^{s_i,s_j}_d$，该方法给予近期的新闻更高的权重。

    $$\hat{R}^{s_i,s_j}_d=\sum\limits_{m=0}^{\delta-1}w_m·R^{s_i,s_j}_{d-m}$$

-   **节点级图注意力层 (Node-level Graph Attention Layer)** 

    这是NGAT模型的**核心创新**。与标准GAT为所有节点使用一套共享的注意力参数不同，NGAT为每个节点（公司）都分配了一套独立的注意力机制参数。这使得模型能够针对每家公司的独特性，学习个性化的信息聚合方式。

    -   **注意力系数计算**: 对于节点 i 和它的邻居节点 j，其注意力系数 $\beta_{ij}$ 的计算过程如下：

    $$\beta_{ij}=\frac{exp(\hat{R}^{i,j}_dLeakReLU(a^T_i[W_qh^i||W_kh^j]))}{\sum\limits_{k\in N(i)}exp(\hat{R}^{i,m}_dLeakReLU(a^T_i[W_qh^i||W_kh^m]))}$$

    -   **邻居信息聚合**: 为防止Softmax归一化可能导致的“过平滑”问题（即过度强调邻居信息而丢失节点自身特性），模型在聚合邻居信息后，还拼接了节点自身的变换后嵌入。

    $$\hat{h}^i=\sigma(W[W_vh^i||\sum\limits_{j\in N(i)}\beta_{ij}W_kh^j])$$

    -   **多头注意力机制 (Multi-head Attention)** : 为增强模型的稳定性和表达能力，NGAT同样采用了多头注意力机制，即将多个独立的注意力计算结果进行拼接或平均。


    1.  首先，对节点的序列嵌入 $h^i$ 和 $h^j$ 进行线性变换，得到查询向量（Query）和键向量（Key）。
    1.  然后，将这两个向量拼接后，通过节点i专属的注意力参数 $\alpha_i$ 进行计算，并结合前述的条件关系属性 $\hat{R}^{i,j}_d$ 进行加权。
    1.  最终，使用LeakyReLU激活函数和Softmax进行归一化，得到最终的注意力系数。

**3. 输出层 (Output Layer)**

最后，将经过多层关系嵌入模块处理后的最终表示向量 $\hat{h}^{'i}$ 输入到一个全连接输出层，得到预测结果 $\hat{y}^{i}$ 。

-   对于回归任务（波动率预测），直接进行线性变换。
-   对于分类任务（收益率趋势预测），则额外经过一个Sigmoid激活函数。
-   模型的损失函数相应地采用均方误差（MSE）或二元交叉熵损失（Binary Cross Entropy）。

* * *

#### **实验设置 (Experiments)**

**1. 数据集**

实验使用了两个公开的日度数据集：

-   **SPNews Dataset**: 包含标普500成分股公司的交易数据和相关新闻数据。
-   **ACL2018 Dataset**: 包含两年的公司交易数据和相关的推文（Tweets）数据，公司间的关系通过推文中股票代码标签（如[#aapl]()）的共现来定义。

对于数值型的交易数据（开、高、低、收、成交量等），进行了三步标准化处理，以消除不同股票价格量纲的差异并减少信息冗余。

**2. 训练设置**

模型的所有超参数均通过在验证集上进行网格搜索确定，例如关系图构建的记忆窗口 $\delta$（最优为5天），预测周期 T（1天、5天、10天、21天，分别对应日、周、双周、月），以及注意力头数等。优化器采用Adam。

**3. 基线模型**

为了全面评估NGAT的性能，本文选取了多种非图模型和图模型作为基线进行对比，包括：

-   非图模型：LSTM。
-   通用图模型：GCN , GAT。
-   金融领域特定图模型：LSTM+GCN , TGC , AD-GAT。

**4. 评估指标**

-   **分类任务 (收益率趋势)** : 采用准确率（ACC）、马修斯相关系数（MCC，适用于类别不均衡场景）和ROC曲线下面积（AUC）。
-   **回归任务 (波动率)** : 采用样本外决定系数（$R^2$）和均方误差（MSE）。

![Image](/img/2025/09/24/基于NGAT模型的股票长期趋势与风险建模/NGAT-img3.webp)

* * *

#### **结果与讨论 (Results and Discussion)**

**1. 收益率趋势预测性能**

实验结果明确显示，**NGAT在两个数据集上的收益率趋势分类任务中均显著优于所有基线模型**。

-   相较于标准的GAT模型，NGAT取得了显著的性能提升，例如在SPNews数据集上当 T=10 时，ACC、MCC和AUC分别相对提升了2.08%、8.12%和1.41%。这充分证明了节点级注意力机制在金融建模中的普适优越性。
-   一个非常重要的发现是，所有模型的长期预测准确率都超过了70%，远高于传统次日预测任务中常见的50-60%的水平，这从实践上肯定了长期预测任务的价值。
-   在四种市场情景的识别上，NGAT尤其擅长捕捉“飙升”和“暴跌”这类关键的投资和避险机会。

**2. 波动率预测性能**

在波动率预测任务中，**NGAT同样稳定地超越了所有基线模型**。

-   实验清晰地表明，基于图的模型相比单纯的序列模型（如LSTM）在波动率预测上具有明显优势，验证了关系信息的重要性。
-   即使在由新闻文本构建的、可能包含噪声的关系图上，NGAT依然表现稳健，证明其能够从不完美的图数据中有效提取可靠信号。
-   一个有趣的现象是，随着预测周期 T 的增长，波动率预测的性能显著提升，其中月度波动率（T=21）的预测效果最好。这与金融实践相符，因为月度波动率比充满噪声的短期波动率在投资组合管理等应用中更具价值。

![Image](/img/2025/09/24/基于NGAT模型的股票长期趋势与风险建模/NGAT-img4.webp)

**3. 综合分析与洞见**

-   一个核心洞见是：**除了NGAT，没有任何一个其他的图模型（无论是通用架构还是金融领域的SOTA模型）能够在所有预测周期和任务上全面超越基础的LSTM模型**。

-   其深层原因是，不同的预测周期需要捕捉不同时间尺度下的动量溢出效应。对于一个公司而言，在周、月等不同尺度下，对其有显著影响的关联公司可能是不同的。传统的共享特征聚合机制（如GAT）无法适应这种动态变化，导致效率低下。而NGAT的节点级注意力机制恰好解决了这个问题，使其能够自适应地调整信息聚合方式，从而在各种时间尺度上都表现出色。
-   综合收益率和波动率的预测结果，将预测周期 T 设为21天（约一个月）是在两个任务上取得性能平衡的理想选择。

**4. 图构建方法对比**

实验还比较了不同图构建方法（如基于新闻共现的动态图、基于收益率相关的动态图等）的性能。

-   结果显示，无论采用何种图构建方法，NGAT的性能始终优于GAT，再次凸显了其架构优势。
-   同时也发现，仅凭下游任务的表现来评估图的“质量”是片面的。例如，在GAT模型下，一种图构建方法可能表现更优；但在更先进的NGAT模型下，由于模型本身强大的容错和信号提取能力，不同图方法之间的性能差异会减小。这说明，先进的模型架构可以在一定程度上弥补图构建过程中的缺陷。

论文来源：[https://arxiv.org/abs/2507.02018](https://arxiv.org/abs/2507.02018)

相关代码：[https://github.com/FreddieNIU/NGAT](https://github.com/FreddieNIU/NGAT)

笔记来源：大头的算法笔记/QuantML